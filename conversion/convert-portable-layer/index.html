
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../conversion-background/">
      
      
        <link rel="next" href="../create-metadata/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>1 - Convert the "portable" layer - CAM-SIMA</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
  
  <style>:root{--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 8H6l6-6 6 6h-4v8h4l-6 6-6-6h4V8Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-convert-the-portable-layer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CAM-SIMA" class="md-header__button md-logo" aria-label="CAM-SIMA" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CAM-SIMA
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1 - Convert the "portable" layer
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CAM-SIMA" class="md-nav__button md-logo" aria-label="CAM-SIMA" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    CAM-SIMA
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Conversion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Conversion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conversion-background/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0 - Background &amp; Prep work
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    1 - Convert the "portable" layer
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    1 - Convert the "portable" layer
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#move-the-portable-layer-to-atmospheric_physics" class="md-nav__link">
    <span class="md-ellipsis">
      Move the portable layer to atmospheric_physics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-pre-split-the-module" class="md-nav__link">
    <span class="md-ellipsis">
      Optional: pre-split the module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1a-change-routine-names" class="md-nav__link">
    <span class="md-ellipsis">
      1a - Change routine names
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1b-add-required-htmlinclude-lines" class="md-nav__link">
    <span class="md-ellipsis">
      1b - Add required \htmlinclude lines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1c-clean-up-dummy-argument-dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      1c - Clean up dummy argument dimensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1d-use-kind_phys-instead-of-r8" class="md-nav__link">
    <span class="md-ellipsis">
      1d - Use kind_phys instead of r8
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1e-remove-use-statements" class="md-nav__link">
    <span class="md-ellipsis">
      1e - Remove use statements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1f-add-error-variables" class="md-nav__link">
    <span class="md-ellipsis">
      1f - Add error variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1g-replace-state-and-ptend-variables-in-calling-list" class="md-nav__link">
    <span class="md-ellipsis">
      1g - Replace state and ptend variables in calling list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1h-remove-pbuf-variables" class="md-nav__link">
    <span class="md-ellipsis">
      1h - Remove pbuf variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1i-mark-variables-as-initialized" class="md-nav__link">
    <span class="md-ellipsis">
      1i - Mark variables as initialized
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1j-initial-standard-name-check" class="md-nav__link">
    <span class="md-ellipsis">
      1j - Initial standard name check
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1k-update-cam-interface-calls" class="md-nav__link">
    <span class="md-ellipsis">
      1k - Update CAM interface call(s)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1l-optional-make-a-cam-tag" class="md-nav__link">
    <span class="md-ellipsis">
      1l - OPTIONAL: Make a CAM tag
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../create-metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 - Create metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../create-namelist-xml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 - Create namelist XML file
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interstitials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 - Interstitials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../create-sdf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 - Create an SDF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../create-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 - Create snapshots of CAM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../check-metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 - Check metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../run-cam-sima/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 - Run CAM-SIMA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../back-to-cam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 - Bring back into CAM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Walkthrough Example
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Design
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/cam-build-process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Build process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/cam-run-process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/ccpp-in-cam-sima/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CCPP in CAM-SIMA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/constituents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constituents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/history/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    History &amp; model output
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../design/sima-design-goals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design goals &amp; features
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Development
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/cam-coding-standards/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Coding standards
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/cam-testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/debugging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging techniques
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/git-basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Working with git and GitHub
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/git-faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git &amp; GitHub FAQ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/git-fleximod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git-fleximod
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/tool-recommendations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tool recommendations
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/creating-a-case/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating, configuring, and running a case
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/history/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    History &amp; model output
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#move-the-portable-layer-to-atmospheric_physics" class="md-nav__link">
    <span class="md-ellipsis">
      Move the portable layer to atmospheric_physics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-pre-split-the-module" class="md-nav__link">
    <span class="md-ellipsis">
      Optional: pre-split the module
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1a-change-routine-names" class="md-nav__link">
    <span class="md-ellipsis">
      1a - Change routine names
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1b-add-required-htmlinclude-lines" class="md-nav__link">
    <span class="md-ellipsis">
      1b - Add required \htmlinclude lines
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1c-clean-up-dummy-argument-dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      1c - Clean up dummy argument dimensions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1d-use-kind_phys-instead-of-r8" class="md-nav__link">
    <span class="md-ellipsis">
      1d - Use kind_phys instead of r8
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1e-remove-use-statements" class="md-nav__link">
    <span class="md-ellipsis">
      1e - Remove use statements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1f-add-error-variables" class="md-nav__link">
    <span class="md-ellipsis">
      1f - Add error variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1g-replace-state-and-ptend-variables-in-calling-list" class="md-nav__link">
    <span class="md-ellipsis">
      1g - Replace state and ptend variables in calling list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1h-remove-pbuf-variables" class="md-nav__link">
    <span class="md-ellipsis">
      1h - Remove pbuf variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1i-mark-variables-as-initialized" class="md-nav__link">
    <span class="md-ellipsis">
      1i - Mark variables as initialized
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1j-initial-standard-name-check" class="md-nav__link">
    <span class="md-ellipsis">
      1j - Initial standard name check
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1k-update-cam-interface-calls" class="md-nav__link">
    <span class="md-ellipsis">
      1k - Update CAM interface call(s)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1l-optional-make-a-cam-tag" class="md-nav__link">
    <span class="md-ellipsis">
      1l - OPTIONAL: Make a CAM tag
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="1-convert-the-portable-layer">1 - Convert the "portable" layer</h1>
<h2 id="move-the-portable-layer-to-atmospheric_physics">Move the portable layer to atmospheric_physics</h2>
<p>The <em>portable</em> parameterization layer is the module that contains the core physics code that is called by the CAM interface.</p>
<p>The portable module will most likely live in <code>$CAM/src/physics/cam</code> or <code>$CAM/src/physics/cam7</code></p>
<p>The driver code in each physics directory is <code>physpkg.F90</code>, which typically calls the CAM interface to the portable layer (often called <code>&lt;parameterization&gt;_cam.F90</code>), but also sometimes calls portable layer directly.
Once you locate the core code that you will be converting, copy it into the new directory you created in the atmospheric_physics submodule directory:</p>
<pre><code>cp $CAM/src/physics/&lt;physics_subdir&gt;/&lt;file&gt;.F90 $CAM-SIMA/src/physics/ncar_ccpp/&lt;parameterization_name&gt;
</code></pre>
<h2 id="optional-pre-split-the-module">Optional: pre-split the module</h2>
<p>Many CAM schemes have more than one "run" or "tend" method contained within them.  To split them into separate files and test them, do the following:</p>
<ul>
<li>In the atmospheric physics directory (<code>ncar_ccpp</code>), create a separate module for each piece which has a "run" or "tend" method.<ul>
<li>An easy way to see what routines need to be separated out, is to look at the "use" statement(s) in <code>physpkg.F90</code> for your parametrization's module.  If more than one routine is listed, you most likely will need to separate these out.</li>
</ul>
</li>
<li>If there is shared, module-level data or shared subroutines which are called internally, put these all in a <scheme_name>_common.F90 module.</li>
</ul>
<h2 id="1a-change-routine-names">1a - Change routine names</h2>
<p>Convert the original routines (except readnl - we'll get to that <a href="../create-namelist-xml/">later</a>!) in the file(s) you copied over to $CAM-SIMA/src/physics/ncar_ccpp to one or more of the following 5 subroutines:</p>
<div class="admonition note">
<p class="admonition-title"><code>&lt;parameterization&gt;</code> should be the full name of your module</p>
<p>For example, if you are converting the <code>tj2016</code> <code>precip_tend</code> function, then <code>&lt;parameterization&gt;</code> would be <code>tj2016_precip_tend</code>.</p>
</div>
<ul>
<li><strong>&lt;parameterization&gt;_init</strong><ul>
<li>Add all code that is run only during the first timestep (nstep=0). Typically, fold register and init routines in current CAM into this routine.</li>
</ul>
</li>
<li><strong>&lt;parameterization&gt;_timestep_init</strong><ul>
<li>Add all pre-processing code needed by the scheme at the start of each timestep. This may contain code from the CAM interface (<code>physpkg.F90</code>) routine which prepares data for the run routine at each timestep</li>
</ul>
</li>
<li><strong>&lt;parameterization&gt;_run</strong><ul>
<li>This is the workhorse routine which is run at each timestep. The bulk of your ported code will likely be here.</li>
<li>Often, the workhorse routine in CAM is called <code>&lt;parameterization&gt;_tend</code></li>
</ul>
</li>
<li><strong>&lt;parameterization&gt;_timestep_final</strong><ul>
<li>Add all post-processing code needed by the scheme at the end of each timestep. This may contain code from the CAM interface routine (in <code>physpkg.F90</code>) which manipulates data after the run routine at each timestep</li>
</ul>
</li>
<li><strong>&lt;parameterization&gt;_final</strong><ul>
<li>Most current CAM routines do not have code in this category. This code is run once at the very end of the CAM model execution.</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may not need all of the routines listed, nor do you need to supply them if they are not needed; however, all subroutine input/output (dummy) arguments need to have an "intent" label.</p>
</div>
<h2 id="1b-add-required-htmlinclude-lines">1b - Add required <code>\htmlinclude</code> lines</h2>
<p>Add two lines before each of the up to 5 phases of subroutines (skip <code>readnl</code>)</p>
<pre><code>!&gt; \section arg_table_&lt;parameterization&gt;_&lt;phase&gt; Argument Table
!! \htmlinclude &lt;parameterization&gt;_&lt;phase&gt;.html
</code></pre>
<h2 id="1c-clean-up-dummy-argument-dimensions">1c - Clean up dummy argument dimensions</h2>
<p>Make sure no input/output variables have named dimensions in their declaration inside the routines.  </p>
<ol>
<li>Replace named dimensions with “:”<ul>
<li>for example: <code>real(r8), intent(in) :: zm(pcols, pver)</code> will become <code>real(r8), intent(in) :: zm(:,:)</code></li>
</ul>
</li>
<li>If a named dimension is no longer used, it may be removed from the calling list (i.e. pcols, etc)</li>
<li>On the CAM interface side, any variables dimensioned by <code>pcols</code> in CAM will need to be subsetted to <code>1:ncol</code> in the call to the CCPP-ized routine so that only the active columns are passed</li>
<li>All <code>intent(out)</code> variables which are dimensioned pcols` should be initialized to zero right before being called in the main CAM physics calling routine to prevent extraneous values from existing in a pcols-dimensioned array.<ul>
<li>Put <code>!REMOVECAM/!REMOVECAM_END</code> labels around these initializations as any which remain after CAM is retired no longer need this precautionary step.</li>
</ul>
</li>
<li>Repeat #1-4 with any routines which are called internally</li>
<li>Search through the code and make sure that all locations which call these updated routines have been modified correctly<ul>
<li>Use the subsetted 1:ncol arrays when calling the updated routine </li>
<li>Initialize all intent(out) arrays to zero before making the call</li>
</ul>
</li>
</ol>
<h2 id="1d-use-kind_phys-instead-of-r8">1d - Use kind_phys instead of r8</h2>
<ol>
<li>Remove <code>use shr_kind_mod, only: r8=&gt; shr_kind_r8</code></li>
<li>Replace with <code>use ccpp_kinds, only: kind_phys</code></li>
<li>Do a find and replace for <code>r8</code> with <code>kind_phys</code> in the module (and any dependencies)</li>
</ol>
<h2 id="1e-remove-use-statements">1e - Remove use statements</h2>
<p>Remove all “use” statements and have the data appear in the calling list (the input and output variables to the routine).  The only exception to this rule is for use statements to routines contained within the parameterization package or dependencies.</p>
<ul>
<li>If a use statement is bringing in a variable from another module (e.g. something from <code>physconst</code>), add the variable to the calling list of the subroutine(s) that use it (and remove the use statement)</li>
<li>If a use statement is bringing in an external routine (not part of the parameterization package), you have a few options (consult with the other CAM SEs on how to proceed):<ol>
<li>If the routine already exists in the core CAM-SIMA code tree (not in <code>ncar_ccpp</code>), ask another CAM SE about how and where to call the routine within the CAM-SIMA run loop and set a variable to be passed into the physics (variable will need to be added to the registry)</li>
<li>CCPP-ize the external routine and/or module and add it to the suite definition file before or after the parameterization</li>
<li>Postpone CCPP-zing the external routine and add it as a dependency (we'll revisit this in <a href="../create-metadata/">create metadata</a>)</li>
</ol>
</li>
<li>Comment out <code>outfld</code>, <code>addfld</code> use statements for now<ul>
<li>Also comment out the <code>addfld</code> and <code>outfld</code> calls within the module(s)</li>
</ul>
</li>
</ul>
<h2 id="1f-add-error-variables">1f - Add error variables</h2>
<p>Add <code>errmsg, errflg</code> to the end of your calling list.  Set <code>errflg</code> to non-zero if an error is encountered in your routine and set <code>errmsg</code> with an appropriate text indicating the error. </p>
<p>The declarations for these variables are:</p>
<pre><code>   character(len=512), intent(out) :: errmsg
   integer,            intent(out) :: errflg
</code></pre>
<p>At the top of your routine initialize the variables as follows:</p>
<pre><code> errmsg = ‘ ‘
 errflg = 0
</code></pre>
<h2 id="1g-replace-state-and-ptend-variables-in-calling-list">1g - Replace state and ptend variables in calling list</h2>
<p><code>state</code> and <code>ptend</code> variables will not be passed in as full objects, but instead as the individual state and ptend fields that are used in the routine.</p>
<p>If <code>state</code> appears in the calling list:</p>
<ol>
<li>Search the routine for "state%" and, for each of the distinct variables found (<code>state%&lt;var&gt;</code>), add the variable (<code>&lt;var&gt;</code>) to the calling list</li>
<li>Replace all calls to <code>state%&lt;var&gt;</code> with <code>&lt;var&gt;</code></li>
<li>Remove <code>state</code> from the calling list</li>
</ol>
<p>If <code>ptend</code> appers in the calling list:</p>
<ol>
<li>Search the routine for "ptend%" and, for each of the distinct variables found (<code>ptend%&lt;var&gt;</code>), add the variable to the calling list<ul>
<li>the variable name is up to you, some suggestions:<ol>
<li><code>&lt;var&gt;_tend</code></li>
<li><code>d&lt;var&gt;dt</code></li>
</ol>
</li>
</ul>
</li>
<li>Replace all calls to <code>state%&lt;var&gt;</code> with the new name</li>
<li>Remove <code>ptend</code> from the calling list</li>
</ol>
<h2 id="1h-remove-pbuf-variables">1h - Remove pbuf variables</h2>
<p>pbuf variables will not be in CCPP code. Instead, pass required individual variables as <code>intent(in)</code>, <code>intent(out)</code> or <code>intent(inout)</code> depending on whether they are being used or set in the interstitial.</p>
<p>For example, if the following line of code exists in a routine:</p>
<pre><code>call pbuf_get_field(pbuf, taubljx_idx, taubljx)
</code></pre>
<p>You will want to search around in the routine (and routines that it calls) to determine if <code>taubljx</code> is read from, written to, or both:</p>
<ol>
<li>If the variable is read from only (e.g. is only on the right-hand side of equations), the variable will be <code>intent(in)</code></li>
<li>If the variable is written to only (e.g. is only on the left-hand side of equations), the variable will be <code>intent(out)</code></li>
<li>If the variable is both read from and written to (e.g. it appears on both sides of equations), the variable will be <code>intent(inout)</code></li>
</ol>
<p>In this example, <code>taubljx</code> is <code>intent(out)</code>, so we'd remove the <code>pbuf_get_field</code> call and add <code>taubljx</code> to the calling list as an ouput variable.</p>
<h2 id="1i-mark-variables-as-initialized">1i - Mark variables as initialized</h2>
<ul>
<li>If you add new variables that do not need to be read in from a file but come directly from the host model/registry and are uninitialized by CAM-SIMA, use the <code>mark_as_initialized</code> subroutine in the <code>&lt;parameterization&gt;_init</code> phase.</li>
<li>Also, if you are setting a (non-namelist) public module level variable(a variable above the contains statement) in CAM-SIMA that will be used by a physics scheme, then also set the mark_as_initialized for that variable (also in the <code>&lt;parameterization&gt;_init</code> phase)</li>
</ul>
<pre><code>use phys_vars_init_check, only: mark_as_initialized
</code></pre>
<pre><code>call mark_as_initialized('&lt;standard name&gt;')
</code></pre>
<h2 id="1j-initial-standard-name-check">1j - Initial standard name check</h2>
<p>Do a preliminary look at the variables on the calling lists and make sure that CCPP standard names and units exist for all of them, by checking for them in CAM Standard Names Spreadsheet.</p>
<ul>
<li>If variables are not filled out in the list, highlight the entire line with yellow.  </li>
<li>If they don't exist at all in the spreadsheet, enter them into the bottom of the sheet and highlight them with yellow.  Note that physconst and diagnostic-only variables <em>may</em> not reside in the spreadsheet.</li>
<li>Let Jesse, Courtney or Cheryl know if you've encountered missing CCPP standardnames and/or units and added them to the list, so they can be discussed at an upcoming meeting.  </li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This process can normally take 2-4 weeks, so a preliminary look is advisable.</p>
</div>
<h2 id="1k-update-cam-interface-calls">1k - Update CAM interface call(s)</h2>
<p>Update the calls in the CAM interface code to reflect any changes to the routine names and calling lists.</p>
<h2 id="1l-optional-make-a-cam-tag">1l - OPTIONAL: Make a CAM tag</h2>
<p>Make NCAR/atmospheric_physics and ESCOMP/CAM tags if substantial changes have been made up to this point.  This is also a good step to take if there is potential for others to be making modifications to the same physics module.  This will allow them to make changes which can be merged via git commands.</p>
<ul>
<li>Do at the very least a sanity compilation and run using the ESCOMP/CAM code base <ul>
<li>Delete the original module from src/physics/cam </li>
<li>Use  your pulled apart modules in atmos_phys/<schemename>.</li>
<li>In bld/configure in the ESCOMP/CAM source code, find the section "Add the CCPP'ized subdirectories".  Add following line:</li>
</ul>
</li>
</ul>
<pre><code>print $fh &quot;$camsrcdir/src/atmos_phys/&lt;schemename&gt;\n&quot;;
</code></pre>
<ul>
<li>Modify code as needed until this modified code compiles and runs properly.</li>
<li>If you want to benchmark your development to this point, you will need to open PRs to both NCAR/atmospheric_physics and ESCOMP/CAM.</li>
</ul>
<p>Proceed to <a href="../create-metadata/">2 - Create metadata</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>